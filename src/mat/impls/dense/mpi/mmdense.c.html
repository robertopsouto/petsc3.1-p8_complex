<center><a href="mmdense.c">Actual source code: mmdense.c</a></center><br>

<html>
<head>
<title></title>
<meta name="generator" content="c2html 0.9.5">
<meta name="date" content="2011-03-17T18:48:52+00:00">
</head>

<body bgcolor="#FFFFFF">
<pre width="80"><a name="line1">  1: </a><strong><font color="#228B22">#define PETSCMAT_DLL</font></strong>

<a name="line3">  3: </a><font color="#B22222">/*</font>
<a name="line4">  4: </a><font color="#B22222">   Support for the parallel dense matrix vector multiply</font>
<a name="line5">  5: </a><font color="#B22222">*/</font>
<a name="line6"> 6: </a> #include <A href="../../../../../include/../src/mat/impls/dense/mpi/mpidense.h.html">../src/mat/impls/dense/mpi/mpidense.h</A>
<a name="line7"> 7: </a> #include <A href="../../../../../include/petscblaslapack.h.html">petscblaslapack.h</A>

<a name="line11"> 11: </a><strong><font color="#4169E1"><a name="MatSetUpMultiply_MPIDense"></a><A href="../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A> MatSetUpMultiply_MPIDense(<A href="../../../../../docs/manualpages/Mat/Mat.html#Mat">Mat</A> mat)</font></strong>
<a name="line12"> 12: </a>{
<a name="line13"> 13: </a>  Mat_MPIDense *mdn = (Mat_MPIDense*)mat-&gt;data;
<a name="line15"> 15: </a>  <A href="../../../../../docs/manualpages/IS/IS.html#IS">IS</A>           from,to;
<a name="line16"> 16: </a>  <A href="../../../../../docs/manualpages/Vec/Vec.html#Vec">Vec</A>          gvec;

<a name="line19"> 19: </a>  <font color="#B22222">/* Create local vector that is used to scatter into */</font>
<a name="line20"> 20: </a>  <A href="../../../../../docs/manualpages/Vec/VecCreateSeq.html#VecCreateSeq">VecCreateSeq</A>(<A href="../../../../../docs/manualpages/Sys/PETSC_COMM_SELF.html#PETSC_COMM_SELF">PETSC_COMM_SELF</A>,mat-&gt;cmap-&gt;N,&amp;mdn-&gt;lvec);

<a name="line22"> 22: </a>  <font color="#B22222">/* Create temporary index set for building scatter gather */</font>
<a name="line23"> 23: </a>  <A href="../../../../../docs/manualpages/IS/ISCreateStride.html#ISCreateStride">ISCreateStride</A>(((<A href="../../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)mat)-&gt;comm,mat-&gt;cmap-&gt;N,0,1,&amp;from);
<a name="line24"> 24: </a>  <A href="../../../../../docs/manualpages/IS/ISCreateStride.html#ISCreateStride">ISCreateStride</A>(<A href="../../../../../docs/manualpages/Sys/PETSC_COMM_SELF.html#PETSC_COMM_SELF">PETSC_COMM_SELF</A>,mat-&gt;cmap-&gt;N,0,1,&amp;to);

<a name="line26"> 26: </a>  <font color="#B22222">/* Create temporary global vector to generate scatter context */</font>
<a name="line27"> 27: </a>  <font color="#B22222">/* n    = mdn-&gt;cowners[mdn-&gt;rank+1] - mdn-&gt;cowners[mdn-&gt;rank]; */</font>

<a name="line29"> 29: </a>  <A href="../../../../../docs/manualpages/Vec/VecCreateMPIWithArray.html#VecCreateMPIWithArray">VecCreateMPIWithArray</A>(((<A href="../../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)mat)-&gt;comm,mdn-&gt;nvec,mat-&gt;cmap-&gt;N,<A href="../../../../../docs/manualpages/Sys/PETSC_NULL.html#PETSC_NULL">PETSC_NULL</A>,&amp;gvec);

<a name="line31"> 31: </a>  <font color="#B22222">/* Generate the scatter context */</font>
<a name="line32"> 32: </a>  <A href="../../../../../docs/manualpages/Vec/VecScatterCreate.html#VecScatterCreate">VecScatterCreate</A>(gvec,from,mdn-&gt;lvec,to,&amp;mdn-&gt;Mvctx);
<a name="line33"> 33: </a>  PetscLogObjectParent(mat,mdn-&gt;Mvctx);
<a name="line34"> 34: </a>  PetscLogObjectParent(mat,mdn-&gt;lvec);
<a name="line35"> 35: </a>  PetscLogObjectParent(mat,from);
<a name="line36"> 36: </a>  PetscLogObjectParent(mat,to);
<a name="line37"> 37: </a>  PetscLogObjectParent(mat,gvec);

<a name="line39"> 39: </a>  <A href="../../../../../docs/manualpages/IS/ISDestroy.html#ISDestroy">ISDestroy</A>(to);
<a name="line40"> 40: </a>  <A href="../../../../../docs/manualpages/IS/ISDestroy.html#ISDestroy">ISDestroy</A>(from);
<a name="line41"> 41: </a>  <A href="../../../../../docs/manualpages/Vec/VecDestroy.html#VecDestroy">VecDestroy</A>(gvec);
<a name="line42"> 42: </a>  <font color="#4169E1">return</font>(0);
<a name="line43"> 43: </a>}

<a name="line45"> 45: </a><strong><font color="#4169E1">EXTERN <A href="../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A> MatGetSubMatrices_MPIDense_Local(<A href="../../../../../docs/manualpages/Mat/Mat.html#Mat">Mat</A>,<A href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>,const <A href="../../../../../docs/manualpages/IS/IS.html#IS">IS</A>[],const <A href="../../../../../docs/manualpages/IS/IS.html#IS">IS</A>[],<A href="../../../../../docs/manualpages/Mat/MatReuse.html#MatReuse">MatReuse</A>,<A href="../../../../../docs/manualpages/Mat/Mat.html#Mat">Mat</A>*)</font></strong>;
<a name="line48"> 48: </a><strong><font color="#4169E1"><a name="MatGetSubMatrices_MPIDense"></a><A href="../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A> MatGetSubMatrices_MPIDense(<A href="../../../../../docs/manualpages/Mat/Mat.html#Mat">Mat</A> C,<A href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A> ismax,const <A href="../../../../../docs/manualpages/IS/IS.html#IS">IS</A> isrow[],const <A href="../../../../../docs/manualpages/IS/IS.html#IS">IS</A> iscol[],<A href="../../../../../docs/manualpages/Mat/MatReuse.html#MatReuse">MatReuse</A> scall,<A href="../../../../../docs/manualpages/Mat/Mat.html#Mat">Mat</A> *submat[])</font></strong>
<a name="line49"> 49: </a>{
<a name="line51"> 51: </a>  <A href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>           nmax,nstages_local,nstages,i,pos,max_no;

<a name="line54"> 54: </a>  <font color="#B22222">/* Allocate memory to hold all the submatrices */</font>
<a name="line55"> 55: </a>  <font color="#4169E1">if</font> (scall != MAT_REUSE_MATRIX) {
<a name="line56"> 56: </a>    <A href="../../../../../docs/manualpages/Sys/PetscMalloc.html#PetscMalloc">PetscMalloc</A>((ismax+1)*<font color="#4169E1">sizeof</font>(<A href="../../../../../docs/manualpages/Mat/Mat.html#Mat">Mat</A>),submat);
<a name="line57"> 57: </a>  }
<a name="line58"> 58: </a>  <font color="#B22222">/* Determine the number of stages through which submatrices are done */</font>
<a name="line59"> 59: </a>  nmax          = 20*1000000 / (C-&gt;cmap-&gt;N * <font color="#4169E1">sizeof</font>(<A href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>));
<a name="line60"> 60: </a>  <font color="#4169E1">if</font> (!nmax) nmax = 1;
<a name="line61"> 61: </a>  nstages_local = ismax/nmax + ((ismax % nmax)?1:0);

<a name="line63"> 63: </a>  <font color="#B22222">/* Make sure every processor loops through the nstages */</font>
<a name="line64"> 64: </a>  <A href="http://www.mcs.anl.gov/mpi/www/www3/MPI_Allreduce.html#MPI_Allreduce">MPI_Allreduce</A>(&amp;nstages_local,&amp;nstages,1,MPIU_INT,MPI_MAX,((<A href="../../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)C)-&gt;comm);


<a name="line67"> 67: </a>  <font color="#4169E1">for</font> (i=0,pos=0; i&lt;nstages; i++) {
<a name="line68"> 68: </a>    <font color="#4169E1">if</font> (pos+nmax &lt;= ismax) max_no = nmax;
<a name="line69"> 69: </a>    <font color="#4169E1">else</font> <font color="#4169E1">if</font> (pos == ismax) max_no = 0;
<a name="line70"> 70: </a>    <font color="#4169E1">else</font>                   max_no = ismax-pos;
<a name="line71"> 71: </a>    MatGetSubMatrices_MPIDense_Local(C,max_no,isrow+pos,iscol+pos,scall,*submat+pos);
<a name="line72"> 72: </a>    pos += max_no;
<a name="line73"> 73: </a>  }
<a name="line74"> 74: </a>  <font color="#4169E1">return</font>(0);
<a name="line75"> 75: </a>}
<a name="line76"> 76: </a><font color="#B22222">/* -------------------------------------------------------------------------*/</font>
<a name="line79"> 79: </a><strong><font color="#4169E1"><a name="MatGetSubMatrices_MPIDense_Local"></a><A href="../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A> MatGetSubMatrices_MPIDense_Local(<A href="../../../../../docs/manualpages/Mat/Mat.html#Mat">Mat</A> C,<A href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A> ismax,const <A href="../../../../../docs/manualpages/IS/IS.html#IS">IS</A> isrow[],const <A href="../../../../../docs/manualpages/IS/IS.html#IS">IS</A> iscol[],<A href="../../../../../docs/manualpages/Mat/MatReuse.html#MatReuse">MatReuse</A> scall,<A href="../../../../../docs/manualpages/Mat/Mat.html#Mat">Mat</A> *submats)</font></strong>
<a name="line80"> 80: </a>{
<a name="line81"> 81: </a>  Mat_MPIDense   *c = (Mat_MPIDense*)C-&gt;data;
<a name="line82"> 82: </a>  <A href="../../../../../docs/manualpages/Mat/Mat.html#Mat">Mat</A>            A = c-&gt;A;
<a name="line83"> 83: </a>  Mat_SeqDense   *a = (Mat_SeqDense*)A-&gt;data,*mat;
<a name="line85"> 85: </a>  <A href="../../../../../docs/manualpages/Sys/PetscMPIInt.html#PetscMPIInt">PetscMPIInt</A>    rank,size,tag0,tag1,idex,end,i;
<a name="line86"> 86: </a>  <A href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>       N = C-&gt;cmap-&gt;N,rstart = C-&gt;rmap-&gt;rstart,count;
<a name="line87"> 87: </a>  const <A href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A> **irow,**icol,*irow_i;
<a name="line88"> 88: </a>  <A href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>       *nrow,*ncol,*w1,*w3,*w4,*rtable,start;
<a name="line89"> 89: </a>  <A href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>       **sbuf1,m,j,k,l,ct1,**rbuf1,row,proc;
<a name="line90"> 90: </a>  <A href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>       nrqs,msz,**ptr,*ctr,*pa,*tmp,bsz,nrqr;
<a name="line91"> 91: </a>  <A href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>       is_no,jmax,**rmap,*rmap_i;
<a name="line92"> 92: </a>  <A href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>       ctr_j,*sbuf1_j,*rbuf1_i;
<a name="line93"> 93: </a>  MPI_Request    *s_waits1,*r_waits1,*s_waits2,*r_waits2;
<a name="line94"> 94: </a>  MPI_Status     *r_status1,*r_status2,*s_status1,*s_status2;
<a name="line95"> 95: </a>  <A href="../../../../../docs/manualpages/Sys/MPI_Comm.html#MPI_Comm">MPI_Comm</A>       comm;
<a name="line96"> 96: </a>  <A href="../../../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</A>    **rbuf2,**sbuf2;
<a name="line97"> 97: </a>  <A href="../../../../../docs/manualpages/Sys/PetscTruth.html#PetscTruth">PetscTruth</A>     sorted;

<a name="line100">100: </a>  comm   = ((<A href="../../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)C)-&gt;comm;
<a name="line101">101: </a>  tag0   = ((<A href="../../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)C)-&gt;tag;
<a name="line102">102: </a>  size   = c-&gt;size;
<a name="line103">103: </a>  rank   = c-&gt;rank;
<a name="line104">104: </a>  m      = C-&gt;rmap-&gt;N;
<a name="line105">105: </a>
<a name="line106">106: </a>  <font color="#B22222">/* Get some new tags to keep the communication clean */</font>
<a name="line107">107: </a>  <A href="../../../../../docs/manualpages/Sys/PetscObjectGetNewTag.html#PetscObjectGetNewTag">PetscObjectGetNewTag</A>((<A href="../../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)C,&amp;tag1);

<a name="line109">109: </a>    <font color="#B22222">/* Check if the col indices are sorted */</font>
<a name="line110">110: </a>  <font color="#4169E1">for</font> (i=0; i&lt;ismax; i++) {
<a name="line111">111: </a>    <A href="../../../../../docs/manualpages/IS/ISSorted.html#ISSorted">ISSorted</A>(isrow[i],&amp;sorted);
<a name="line112">112: </a>    <font color="#4169E1">if</font> (!sorted) <A href="../../../../../docs/manualpages/Sys/SETERRQ.html#SETERRQ">SETERRQ</A>(PETSC_ERR_ARG_WRONGSTATE,<font color="#666666">"ISrow is not sorted"</font>);
<a name="line113">113: </a>    <A href="../../../../../docs/manualpages/IS/ISSorted.html#ISSorted">ISSorted</A>(iscol[i],&amp;sorted);
<a name="line114">114: </a>    <font color="#4169E1">if</font> (!sorted) <A href="../../../../../docs/manualpages/Sys/SETERRQ.html#SETERRQ">SETERRQ</A>(PETSC_ERR_ARG_WRONGSTATE,<font color="#666666">"IScol is not sorted"</font>);
<a name="line115">115: </a>  }

<a name="line117">117: </a>  <A href="../../../../../docs/manualpages/Sys/PetscMalloc5.html#PetscMalloc5">PetscMalloc5</A>(ismax,const <A href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>*,&amp;irow,ismax,const <A href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>*,&amp;icol,ismax,<A href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>,&amp;nrow,ismax,<A href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>,&amp;ncol,m,<A href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>,&amp;rtable);
<a name="line118">118: </a>  <font color="#4169E1">for</font> (i=0; i&lt;ismax; i++) {
<a name="line119">119: </a>    <A href="../../../../../docs/manualpages/IS/ISGetIndices.html#ISGetIndices">ISGetIndices</A>(isrow[i],&amp;irow[i]);
<a name="line120">120: </a>    <A href="../../../../../docs/manualpages/IS/ISGetIndices.html#ISGetIndices">ISGetIndices</A>(iscol[i],&amp;icol[i]);
<a name="line121">121: </a>    <A href="../../../../../docs/manualpages/IS/ISGetLocalSize.html#ISGetLocalSize">ISGetLocalSize</A>(isrow[i],&amp;nrow[i]);
<a name="line122">122: </a>    <A href="../../../../../docs/manualpages/IS/ISGetLocalSize.html#ISGetLocalSize">ISGetLocalSize</A>(iscol[i],&amp;ncol[i]);
<a name="line123">123: </a>  }

<a name="line125">125: </a>  <font color="#B22222">/* Create hash table for the mapping :row -&gt; proc*/</font>
<a name="line126">126: </a>  <font color="#4169E1">for</font> (i=0,j=0; i&lt;size; i++) {
<a name="line127">127: </a>    jmax = C-&gt;rmap-&gt;range[i+1];
<a name="line128">128: </a>    <font color="#4169E1">for</font> (; j&lt;jmax; j++) {
<a name="line129">129: </a>      rtable[j] = i;
<a name="line130">130: </a>    }
<a name="line131">131: </a>  }

<a name="line133">133: </a>  <font color="#B22222">/* evaluate communication - mesg to who,length of mesg, and buffer space</font>
<a name="line134">134: </a><font color="#B22222">     required. Based on this, buffers are allocated, and data copied into them*/</font>
<a name="line135">135: </a>  <A href="../../../../../docs/manualpages/Sys/PetscMalloc3.html#PetscMalloc3">PetscMalloc3</A>(2*size,<A href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>,&amp;w1,size,<A href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>,&amp;w3,size,<A href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>,&amp;w4);
<a name="line136">136: </a>  <A href="../../../../../docs/manualpages/Sys/PetscMemzero.html#PetscMemzero">PetscMemzero</A>(w1,size*2*<font color="#4169E1">sizeof</font>(<A href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>)); <font color="#B22222">/* initialize work vector*/</font>
<a name="line137">137: </a>  <A href="../../../../../docs/manualpages/Sys/PetscMemzero.html#PetscMemzero">PetscMemzero</A>(w3,size*<font color="#4169E1">sizeof</font>(<A href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>)); <font color="#B22222">/* initialize work vector*/</font>
<a name="line138">138: </a>  <font color="#4169E1">for</font> (i=0; i&lt;ismax; i++) {
<a name="line139">139: </a>    <A href="../../../../../docs/manualpages/Sys/PetscMemzero.html#PetscMemzero">PetscMemzero</A>(w4,size*<font color="#4169E1">sizeof</font>(<A href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>)); <font color="#B22222">/* initialize work vector*/</font>
<a name="line140">140: </a>    jmax   = nrow[i];
<a name="line141">141: </a>    irow_i = irow[i];
<a name="line142">142: </a>    <font color="#4169E1">for</font> (j=0; j&lt;jmax; j++) {
<a name="line143">143: </a>      row  = irow_i[j];
<a name="line144">144: </a>      proc = rtable[row];
<a name="line145">145: </a>      w4[proc]++;
<a name="line146">146: </a>    }
<a name="line147">147: </a>    <font color="#4169E1">for</font> (j=0; j&lt;size; j++) {
<a name="line148">148: </a>      <font color="#4169E1">if</font> (w4[j]) { w1[2*j] += w4[j];  w3[j]++;}
<a name="line149">149: </a>    }
<a name="line150">150: </a>  }
<a name="line151">151: </a>
<a name="line152">152: </a>  nrqs       = 0;              <font color="#B22222">/* no of outgoing messages */</font>
<a name="line153">153: </a>  msz        = 0;              <font color="#B22222">/* total mesg length (for all procs) */</font>
<a name="line154">154: </a>  w1[2*rank] = 0;              <font color="#B22222">/* no mesg sent to self */</font>
<a name="line155">155: </a>  w3[rank]   = 0;
<a name="line156">156: </a>  <font color="#4169E1">for</font> (i=0; i&lt;size; i++) {
<a name="line157">157: </a>    <font color="#4169E1">if</font> (w1[2*i])  { w1[2*i+1] = 1; nrqs++;} <font color="#B22222">/* there exists a message to proc i */</font>
<a name="line158">158: </a>  }
<a name="line159">159: </a>  <A href="../../../../../docs/manualpages/Sys/PetscMalloc.html#PetscMalloc">PetscMalloc</A>((nrqs+1)*<font color="#4169E1">sizeof</font>(<A href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>),&amp;pa); <font color="#B22222">/*(proc -array)*/</font>
<a name="line160">160: </a>  <font color="#4169E1">for</font> (i=0,j=0; i&lt;size; i++) {
<a name="line161">161: </a>    <font color="#4169E1">if</font> (w1[2*i]) { pa[j] = i; j++; }
<a name="line162">162: </a>  }

<a name="line164">164: </a>  <font color="#B22222">/* Each message would have a header = 1 + 2*(no of <A href="../../../../../docs/manualpages/IS/IS.html#IS">IS</A>) + data */</font>
<a name="line165">165: </a>  <font color="#4169E1">for</font> (i=0; i&lt;nrqs; i++) {
<a name="line166">166: </a>    j       = pa[i];
<a name="line167">167: </a>    w1[2*j] += w1[2*j+1] + 2* w3[j];
<a name="line168">168: </a>    msz     += w1[2*j];
<a name="line169">169: </a>  }
<a name="line170">170: </a>  <font color="#B22222">/* Do a global reduction to determine how many messages to expect*/</font>
<a name="line171">171: </a>  PetscMaxSum(comm,w1,&amp;bsz,&amp;nrqr);

<a name="line173">173: </a>  <font color="#B22222">/* Allocate memory for recv buffers . Make sure rbuf1[0] exists by adding 1 to the buffer length */</font>
<a name="line174">174: </a>  <A href="../../../../../docs/manualpages/Sys/PetscMalloc.html#PetscMalloc">PetscMalloc</A>((nrqr+1)*<font color="#4169E1">sizeof</font>(<A href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>*),&amp;rbuf1);
<a name="line175">175: </a>  <A href="../../../../../docs/manualpages/Sys/PetscMalloc.html#PetscMalloc">PetscMalloc</A>(nrqr*bsz*<font color="#4169E1">sizeof</font>(<A href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>),&amp;rbuf1[0]);
<a name="line176">176: </a>  <font color="#4169E1">for</font> (i=1; i&lt;nrqr; ++i) rbuf1[i] = rbuf1[i-1] + bsz;
<a name="line177">177: </a>
<a name="line178">178: </a>  <font color="#B22222">/* Post the receives */</font>
<a name="line179">179: </a>  <A href="../../../../../docs/manualpages/Sys/PetscMalloc.html#PetscMalloc">PetscMalloc</A>((nrqr+1)*<font color="#4169E1">sizeof</font>(MPI_Request),&amp;r_waits1);
<a name="line180">180: </a>  <font color="#4169E1">for</font> (i=0; i&lt;nrqr; ++i) {
<a name="line181">181: </a>    <A href="http://www.mcs.anl.gov/mpi/www/www3/MPI_Irecv.html#MPI_Irecv">MPI_Irecv</A>(rbuf1[i],bsz,MPIU_INT,MPI_ANY_SOURCE,tag0,comm,r_waits1+i);
<a name="line182">182: </a>  }

<a name="line184">184: </a>  <font color="#B22222">/* Allocate Memory for outgoing messages */</font>
<a name="line185">185: </a>  <A href="../../../../../docs/manualpages/Sys/PetscMalloc4.html#PetscMalloc4">PetscMalloc4</A>(size,<A href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>*,&amp;sbuf1,size,<A href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>*,&amp;ptr,2*msz,<A href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>,&amp;tmp,size,<A href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>,&amp;ctr);
<a name="line186">186: </a>  <A href="../../../../../docs/manualpages/Sys/PetscMemzero.html#PetscMemzero">PetscMemzero</A>(sbuf1,size*<font color="#4169E1">sizeof</font>(<A href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>*));
<a name="line187">187: </a>  <A href="../../../../../docs/manualpages/Sys/PetscMemzero.html#PetscMemzero">PetscMemzero</A>(ptr,size*<font color="#4169E1">sizeof</font>(<A href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>*));
<a name="line188">188: </a>  {
<a name="line189">189: </a>    <A href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A> *iptr = tmp,ict = 0;
<a name="line190">190: </a>    <font color="#4169E1">for</font> (i=0; i&lt;nrqs; i++) {
<a name="line191">191: </a>      j         = pa[i];
<a name="line192">192: </a>      iptr     += ict;
<a name="line193">193: </a>      sbuf1[j]  = iptr;
<a name="line194">194: </a>      ict       = w1[2*j];
<a name="line195">195: </a>    }
<a name="line196">196: </a>  }

<a name="line198">198: </a>  <font color="#B22222">/* Form the outgoing messages */</font>
<a name="line199">199: </a>  <font color="#B22222">/* Initialize the header space */</font>
<a name="line200">200: </a>  <font color="#4169E1">for</font> (i=0; i&lt;nrqs; i++) {
<a name="line201">201: </a>    j           = pa[i];
<a name="line202">202: </a>    sbuf1[j][0] = 0;
<a name="line203">203: </a>    <A href="../../../../../docs/manualpages/Sys/PetscMemzero.html#PetscMemzero">PetscMemzero</A>(sbuf1[j]+1,2*w3[j]*<font color="#4169E1">sizeof</font>(<A href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>));
<a name="line204">204: </a>    ptr[j]      = sbuf1[j] + 2*w3[j] + 1;
<a name="line205">205: </a>  }
<a name="line206">206: </a>
<a name="line207">207: </a>  <font color="#B22222">/* Parse the isrow and copy data into outbuf */</font>
<a name="line208">208: </a>  <font color="#4169E1">for</font> (i=0; i&lt;ismax; i++) {
<a name="line209">209: </a>    <A href="../../../../../docs/manualpages/Sys/PetscMemzero.html#PetscMemzero">PetscMemzero</A>(ctr,size*<font color="#4169E1">sizeof</font>(<A href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>));
<a name="line210">210: </a>    irow_i = irow[i];
<a name="line211">211: </a>    jmax   = nrow[i];
<a name="line212">212: </a>    <font color="#4169E1">for</font> (j=0; j&lt;jmax; j++) {  <font color="#B22222">/* parse the indices of each <A href="../../../../../docs/manualpages/IS/IS.html#IS">IS</A> */</font>
<a name="line213">213: </a>      row  = irow_i[j];
<a name="line214">214: </a>      proc = rtable[row];
<a name="line215">215: </a>      <font color="#4169E1">if</font> (proc != rank) { <font color="#B22222">/* copy to the outgoing buf*/</font>
<a name="line216">216: </a>        ctr[proc]++;
<a name="line217">217: </a>        *ptr[proc] = row;
<a name="line218">218: </a>        ptr[proc]++;
<a name="line219">219: </a>      }
<a name="line220">220: </a>    }
<a name="line221">221: </a>    <font color="#B22222">/* Update the headers for the current <A href="../../../../../docs/manualpages/IS/IS.html#IS">IS</A> */</font>
<a name="line222">222: </a>    <font color="#4169E1">for</font> (j=0; j&lt;size; j++) { <font color="#B22222">/* Can Optimise this loop too */</font>
<a name="line223">223: </a>      <font color="#4169E1">if</font> ((ctr_j = ctr[j])) {
<a name="line224">224: </a>        sbuf1_j        = sbuf1[j];
<a name="line225">225: </a>        k              = ++sbuf1_j[0];
<a name="line226">226: </a>        sbuf1_j[2*k]   = ctr_j;
<a name="line227">227: </a>        sbuf1_j[2*k-1] = i;
<a name="line228">228: </a>      }
<a name="line229">229: </a>    }
<a name="line230">230: </a>  }

<a name="line232">232: </a>  <font color="#B22222">/*  Now  post the sends */</font>
<a name="line233">233: </a>  <A href="../../../../../docs/manualpages/Sys/PetscMalloc.html#PetscMalloc">PetscMalloc</A>((nrqs+1)*<font color="#4169E1">sizeof</font>(MPI_Request),&amp;s_waits1);
<a name="line234">234: </a>  <font color="#4169E1">for</font> (i=0; i&lt;nrqs; ++i) {
<a name="line235">235: </a>    j = pa[i];
<a name="line236">236: </a>    <A href="http://www.mcs.anl.gov/mpi/www/www3/MPI_Isend.html#MPI_Isend">MPI_Isend</A>(sbuf1[j],w1[2*j],MPIU_INT,j,tag0,comm,s_waits1+i);
<a name="line237">237: </a>  }

<a name="line239">239: </a>  <font color="#B22222">/* Post recieves to capture the row_data from other procs */</font>
<a name="line240">240: </a>  <A href="../../../../../docs/manualpages/Sys/PetscMalloc.html#PetscMalloc">PetscMalloc</A>((nrqs+1)*<font color="#4169E1">sizeof</font>(MPI_Request),&amp;r_waits2);
<a name="line241">241: </a>  <A href="../../../../../docs/manualpages/Sys/PetscMalloc.html#PetscMalloc">PetscMalloc</A>((nrqs+1)*<font color="#4169E1">sizeof</font>(<A href="../../../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</A>*),&amp;rbuf2);
<a name="line242">242: </a>  <font color="#4169E1">for</font> (i=0; i&lt;nrqs; i++) {
<a name="line243">243: </a>    j        = pa[i];
<a name="line244">244: </a>    count    = (w1[2*j] - (2*sbuf1[j][0] + 1))*N;
<a name="line245">245: </a>    <A href="../../../../../docs/manualpages/Sys/PetscMalloc.html#PetscMalloc">PetscMalloc</A>((count+1)*<font color="#4169E1">sizeof</font>(<A href="../../../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</A>),&amp;rbuf2[i]);
<a name="line246">246: </a>    <A href="http://www.mcs.anl.gov/mpi/www/www3/MPI_Irecv.html#MPI_Irecv">MPI_Irecv</A>(rbuf2[i],count,<A href="../../../../../docs/manualpages/Sys/MPIU_SCALAR.html#MPIU_SCALAR">MPIU_SCALAR</A>,j,tag1,comm,r_waits2+i);
<a name="line247">247: </a>  }

<a name="line249">249: </a>  <font color="#B22222">/* Receive messages(row_nos) and then, pack and send off the rowvalues</font>
<a name="line250">250: </a><font color="#B22222">     to the correct processors */</font>

<a name="line252">252: </a>  <A href="../../../../../docs/manualpages/Sys/PetscMalloc.html#PetscMalloc">PetscMalloc</A>((nrqr+1)*<font color="#4169E1">sizeof</font>(MPI_Request),&amp;s_waits2);
<a name="line253">253: </a>  <A href="../../../../../docs/manualpages/Sys/PetscMalloc.html#PetscMalloc">PetscMalloc</A>((nrqr+1)*<font color="#4169E1">sizeof</font>(MPI_Status),&amp;r_status1);
<a name="line254">254: </a>  <A href="../../../../../docs/manualpages/Sys/PetscMalloc.html#PetscMalloc">PetscMalloc</A>((nrqr+1)*<font color="#4169E1">sizeof</font>(<A href="../../../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</A>*),&amp;sbuf2);
<a name="line255">255: </a>
<a name="line256">256: </a>  {
<a name="line257">257: </a>    <A href="../../../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</A> *sbuf2_i,*v_start;
<a name="line258">258: </a>    <A href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>         s_proc;
<a name="line259">259: </a>    <font color="#4169E1">for</font> (i=0; i&lt;nrqr; ++i) {
<a name="line260">260: </a>      <A href="http://www.mcs.anl.gov/mpi/www/www3/MPI_Waitany.html#MPI_Waitany">MPI_Waitany</A>(nrqr,r_waits1,&amp;idex,r_status1+i);
<a name="line261">261: </a>      s_proc          = r_status1[i].MPI_SOURCE; <font color="#B22222">/* send processor */</font>
<a name="line262">262: </a>      rbuf1_i         = rbuf1[idex]; <font color="#B22222">/* Actual message from s_proc */</font>
<a name="line263">263: </a>      <font color="#B22222">/* no of rows = end - start; since start is array idex[], 0idex, whel end</font>
<a name="line264">264: </a><font color="#B22222">         is length of the buffer - which is 1idex */</font>
<a name="line265">265: </a>      start           = 2*rbuf1_i[0] + 1;
<a name="line266">266: </a>      <A href="http://www.mcs.anl.gov/mpi/www/www3/MPI_Get_count.html#MPI_Get_count">MPI_Get_count</A>(r_status1+i,MPIU_INT,&amp;end);
<a name="line267">267: </a>      <font color="#B22222">/* allocate memory sufficinet to hold all the row values */</font>
<a name="line268">268: </a>      <A href="../../../../../docs/manualpages/Sys/PetscMalloc.html#PetscMalloc">PetscMalloc</A>((end-start)*N*<font color="#4169E1">sizeof</font>(<A href="../../../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</A>),&amp;sbuf2[idex]);
<a name="line269">269: </a>      sbuf2_i      = sbuf2[idex];
<a name="line270">270: </a>      <font color="#B22222">/* Now pack the data */</font>
<a name="line271">271: </a>      <font color="#4169E1">for</font> (j=start; j&lt;end; j++) {
<a name="line272">272: </a>        row = rbuf1_i[j] - rstart;
<a name="line273">273: </a>        v_start = a-&gt;v + row;
<a name="line274">274: </a>        <font color="#4169E1">for</font> (k=0; k&lt;N; k++) {
<a name="line275">275: </a>          sbuf2_i[0] = v_start[0];
<a name="line276">276: </a>          sbuf2_i++; v_start += C-&gt;rmap-&gt;n;
<a name="line277">277: </a>        }
<a name="line278">278: </a>      }
<a name="line279">279: </a>      <font color="#B22222">/* Now send off the data */</font>
<a name="line280">280: </a>      <A href="http://www.mcs.anl.gov/mpi/www/www3/MPI_Isend.html#MPI_Isend">MPI_Isend</A>(sbuf2[idex],(end-start)*N,<A href="../../../../../docs/manualpages/Sys/MPIU_SCALAR.html#MPIU_SCALAR">MPIU_SCALAR</A>,s_proc,tag1,comm,s_waits2+i);
<a name="line281">281: </a>    }
<a name="line282">282: </a>  }
<a name="line283">283: </a>  <font color="#B22222">/* End Send-Recv of <A href="../../../../../docs/manualpages/IS/IS.html#IS">IS</A> + row_numbers */</font>
<a name="line284">284: </a>  <A href="../../../../../docs/manualpages/Sys/PetscFree.html#PetscFree">PetscFree</A>(r_status1);
<a name="line285">285: </a>  <A href="../../../../../docs/manualpages/Sys/PetscFree.html#PetscFree">PetscFree</A>(r_waits1);
<a name="line286">286: </a>  <A href="../../../../../docs/manualpages/Sys/PetscMalloc.html#PetscMalloc">PetscMalloc</A>((nrqs+1)*<font color="#4169E1">sizeof</font>(MPI_Status),&amp;s_status1);
<a name="line287">287: </a>  <font color="#4169E1">if</font> (nrqs) {<A href="http://www.mcs.anl.gov/mpi/www/www3/MPI_Waitall.html#MPI_Waitall">MPI_Waitall</A>(nrqs,s_waits1,s_status1);}
<a name="line288">288: </a>  <A href="../../../../../docs/manualpages/Sys/PetscFree.html#PetscFree">PetscFree</A>(s_status1);
<a name="line289">289: </a>  <A href="../../../../../docs/manualpages/Sys/PetscFree.html#PetscFree">PetscFree</A>(s_waits1);

<a name="line291">291: </a>  <font color="#B22222">/* Create the submatrices */</font>
<a name="line292">292: </a>  <font color="#4169E1">if</font> (scall == MAT_REUSE_MATRIX) {
<a name="line293">293: </a>    <font color="#4169E1">for</font> (i=0; i&lt;ismax; i++) {
<a name="line294">294: </a>      mat = (Mat_SeqDense *)(submats[i]-&gt;data);
<a name="line295">295: </a>      <font color="#4169E1">if</font> ((submats[i]-&gt;rmap-&gt;n != nrow[i]) || (submats[i]-&gt;cmap-&gt;n != ncol[i])) {
<a name="line296">296: </a>        <A href="../../../../../docs/manualpages/Sys/SETERRQ.html#SETERRQ">SETERRQ</A>(PETSC_ERR_ARG_SIZ,<font color="#666666">"Cannot reuse matrix. wrong size"</font>);
<a name="line297">297: </a>      }
<a name="line298">298: </a>      <A href="../../../../../docs/manualpages/Sys/PetscMemzero.html#PetscMemzero">PetscMemzero</A>(mat-&gt;v,submats[i]-&gt;rmap-&gt;n*submats[i]-&gt;cmap-&gt;n*<font color="#4169E1">sizeof</font>(<A href="../../../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</A>));
<a name="line299">299: </a>      submats[i]-&gt;factor = C-&gt;factor;
<a name="line300">300: </a>    }
<a name="line301">301: </a>  } <font color="#4169E1">else</font> {
<a name="line302">302: </a>    <font color="#4169E1">for</font> (i=0; i&lt;ismax; i++) {
<a name="line303">303: </a>      <A href="../../../../../docs/manualpages/Mat/MatCreate.html#MatCreate">MatCreate</A>(<A href="../../../../../docs/manualpages/Sys/PETSC_COMM_SELF.html#PETSC_COMM_SELF">PETSC_COMM_SELF</A>,submats+i);
<a name="line304">304: </a>      <A href="../../../../../docs/manualpages/Mat/MatSetSizes.html#MatSetSizes">MatSetSizes</A>(submats[i],nrow[i],ncol[i],nrow[i],ncol[i]);
<a name="line305">305: </a>      <A href="../../../../../docs/manualpages/Mat/MatSetType.html#MatSetType">MatSetType</A>(submats[i],((<A href="../../../../../docs/manualpages/Sys/PetscObject.html#PetscObject">PetscObject</A>)A)-&gt;type_name);
<a name="line306">306: </a>      <A href="../../../../../docs/manualpages/Mat/MatSeqDenseSetPreallocation.html#MatSeqDenseSetPreallocation">MatSeqDenseSetPreallocation</A>(submats[i],<A href="../../../../../docs/manualpages/Sys/PETSC_NULL.html#PETSC_NULL">PETSC_NULL</A>);
<a name="line307">307: </a>    }
<a name="line308">308: </a>  }
<a name="line309">309: </a>
<a name="line310">310: </a>  <font color="#B22222">/* Assemble the matrices */</font>
<a name="line311">311: </a>  {
<a name="line312">312: </a>    <A href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>         col;
<a name="line313">313: </a>    <A href="../../../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</A> *imat_v,*mat_v,*imat_vi,*mat_vi;
<a name="line314">314: </a>
<a name="line315">315: </a>    <font color="#4169E1">for</font> (i=0; i&lt;ismax; i++) {
<a name="line316">316: </a>      mat       = (Mat_SeqDense*)submats[i]-&gt;data;
<a name="line317">317: </a>      mat_v     = a-&gt;v;
<a name="line318">318: </a>      imat_v    = mat-&gt;v;
<a name="line319">319: </a>      irow_i    = irow[i];
<a name="line320">320: </a>      m         = nrow[i];
<a name="line321">321: </a>      <font color="#4169E1">for</font> (j=0; j&lt;m; j++) {
<a name="line322">322: </a>        row      = irow_i[j] ;
<a name="line323">323: </a>        proc     = rtable[row];
<a name="line324">324: </a>        <font color="#4169E1">if</font> (proc == rank) {
<a name="line325">325: </a>          row      = row - rstart;
<a name="line326">326: </a>          mat_vi   = mat_v + row;
<a name="line327">327: </a>          imat_vi  = imat_v + j;
<a name="line328">328: </a>          <font color="#4169E1">for</font> (k=0; k&lt;ncol[i]; k++) {
<a name="line329">329: </a>            col = icol[i][k];
<a name="line330">330: </a>            imat_vi[k*m] = mat_vi[col*C-&gt;rmap-&gt;n];
<a name="line331">331: </a>          }
<a name="line332">332: </a>        }
<a name="line333">333: </a>      }
<a name="line334">334: </a>    }
<a name="line335">335: </a>  }

<a name="line337">337: </a>  <font color="#B22222">/* Create row map-&gt; This maps c-&gt;row to submat-&gt;row for each submat*/</font>
<a name="line338">338: </a>  <font color="#B22222">/* this is a very expensive operation wrt memory usage */</font>
<a name="line339">339: </a>  <A href="../../../../../docs/manualpages/Sys/PetscMalloc.html#PetscMalloc">PetscMalloc</A>(ismax*<font color="#4169E1">sizeof</font>(<A href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>*),&amp;rmap);
<a name="line340">340: </a>  <A href="../../../../../docs/manualpages/Sys/PetscMalloc.html#PetscMalloc">PetscMalloc</A>(ismax*C-&gt;rmap-&gt;N*<font color="#4169E1">sizeof</font>(<A href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>),&amp;rmap[0]);
<a name="line341">341: </a>  <A href="../../../../../docs/manualpages/Sys/PetscMemzero.html#PetscMemzero">PetscMemzero</A>(rmap[0],ismax*C-&gt;rmap-&gt;N*<font color="#4169E1">sizeof</font>(<A href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>));
<a name="line342">342: </a>  <font color="#4169E1">for</font> (i=1; i&lt;ismax; i++) { rmap[i] = rmap[i-1] + C-&gt;rmap-&gt;N;}
<a name="line343">343: </a>  <font color="#4169E1">for</font> (i=0; i&lt;ismax; i++) {
<a name="line344">344: </a>    rmap_i = rmap[i];
<a name="line345">345: </a>    irow_i = irow[i];
<a name="line346">346: </a>    jmax   = nrow[i];
<a name="line347">347: </a>    <font color="#4169E1">for</font> (j=0; j&lt;jmax; j++) {
<a name="line348">348: </a>      rmap_i[irow_i[j]] = j;
<a name="line349">349: </a>    }
<a name="line350">350: </a>  }
<a name="line351">351: </a>
<a name="line352">352: </a>  <font color="#B22222">/* Now Receive the row_values and assemble the rest of the matrix */</font>
<a name="line353">353: </a>  <A href="../../../../../docs/manualpages/Sys/PetscMalloc.html#PetscMalloc">PetscMalloc</A>((nrqs+1)*<font color="#4169E1">sizeof</font>(MPI_Status),&amp;r_status2);
<a name="line354">354: </a>  {
<a name="line355">355: </a>    <A href="../../../../../docs/manualpages/Sys/PetscInt.html#PetscInt">PetscInt</A>    is_max,tmp1,col,*sbuf1_i,is_sz;
<a name="line356">356: </a>    <A href="../../../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</A> *rbuf2_i,*imat_v,*imat_vi;
<a name="line357">357: </a>
<a name="line358">358: </a>    <font color="#4169E1">for</font> (tmp1=0; tmp1&lt;nrqs; tmp1++) { <font color="#B22222">/* For each message */</font>
<a name="line359">359: </a>      <A href="http://www.mcs.anl.gov/mpi/www/www3/MPI_Waitany.html#MPI_Waitany">MPI_Waitany</A>(nrqs,r_waits2,&amp;i,r_status2+tmp1);
<a name="line360">360: </a>      <font color="#B22222">/* Now dig out the corresponding sbuf1, which contains the <A href="../../../../../docs/manualpages/IS/IS.html#IS">IS</A> data_structure */</font>
<a name="line361">361: </a>      sbuf1_i = sbuf1[pa[i]];
<a name="line362">362: </a>      is_max  = sbuf1_i[0];
<a name="line363">363: </a>      ct1     = 2*is_max+1;
<a name="line364">364: </a>      rbuf2_i = rbuf2[i];
<a name="line365">365: </a>      <font color="#4169E1">for</font> (j=1; j&lt;=is_max; j++) { <font color="#B22222">/* For each <A href="../../../../../docs/manualpages/IS/IS.html#IS">IS</A> belonging to the message */</font>
<a name="line366">366: </a>        is_no     = sbuf1_i[2*j-1];
<a name="line367">367: </a>        is_sz     = sbuf1_i[2*j];
<a name="line368">368: </a>        mat       = (Mat_SeqDense*)submats[is_no]-&gt;data;
<a name="line369">369: </a>        imat_v    = mat-&gt;v;
<a name="line370">370: </a>        rmap_i    = rmap[is_no];
<a name="line371">371: </a>        m         = nrow[is_no];
<a name="line372">372: </a>        <font color="#4169E1">for</font> (k=0; k&lt;is_sz; k++,rbuf2_i+=N) {  <font color="#B22222">/* For each row */</font>
<a name="line373">373: </a>          row      = sbuf1_i[ct1]; ct1++;
<a name="line374">374: </a>          row      = rmap_i[row];
<a name="line375">375: </a>          imat_vi  = imat_v + row;
<a name="line376">376: </a>          <font color="#4169E1">for</font> (l=0; l&lt;ncol[is_no]; l++) { <font color="#B22222">/* For each col */</font>
<a name="line377">377: </a>            col = icol[is_no][l];
<a name="line378">378: </a>            imat_vi[l*m] = rbuf2_i[col];
<a name="line379">379: </a>          }
<a name="line380">380: </a>        }
<a name="line381">381: </a>      }
<a name="line382">382: </a>    }
<a name="line383">383: </a>  }
<a name="line384">384: </a>  <font color="#B22222">/* End Send-Recv of row_values */</font>
<a name="line385">385: </a>  <A href="../../../../../docs/manualpages/Sys/PetscFree.html#PetscFree">PetscFree</A>(r_status2);
<a name="line386">386: </a>  <A href="../../../../../docs/manualpages/Sys/PetscFree.html#PetscFree">PetscFree</A>(r_waits2);
<a name="line387">387: </a>  <A href="../../../../../docs/manualpages/Sys/PetscMalloc.html#PetscMalloc">PetscMalloc</A>((nrqr+1)*<font color="#4169E1">sizeof</font>(MPI_Status),&amp;s_status2);
<a name="line388">388: </a>  <font color="#4169E1">if</font> (nrqr) {<A href="http://www.mcs.anl.gov/mpi/www/www3/MPI_Waitall.html#MPI_Waitall">MPI_Waitall</A>(nrqr,s_waits2,s_status2);}
<a name="line389">389: </a>  <A href="../../../../../docs/manualpages/Sys/PetscFree.html#PetscFree">PetscFree</A>(s_status2);
<a name="line390">390: </a>  <A href="../../../../../docs/manualpages/Sys/PetscFree.html#PetscFree">PetscFree</A>(s_waits2);

<a name="line392">392: </a>  <font color="#B22222">/* Restore the indices */</font>
<a name="line393">393: </a>  <font color="#4169E1">for</font> (i=0; i&lt;ismax; i++) {
<a name="line394">394: </a>    <A href="../../../../../docs/manualpages/IS/ISRestoreIndices.html#ISRestoreIndices">ISRestoreIndices</A>(isrow[i],irow+i);
<a name="line395">395: </a>    <A href="../../../../../docs/manualpages/IS/ISRestoreIndices.html#ISRestoreIndices">ISRestoreIndices</A>(iscol[i],icol+i);
<a name="line396">396: </a>  }

<a name="line398">398: </a>  <font color="#B22222">/* Destroy allocated memory */</font>
<a name="line399">399: </a>  <A href="../../../../../docs/manualpages/Sys/PetscFree5.html#PetscFree5">PetscFree5</A>(irow,icol,nrow,ncol,rtable);
<a name="line400">400: </a>  <A href="../../../../../docs/manualpages/Sys/PetscFree3.html#PetscFree3">PetscFree3</A>(w1,w3,w4);
<a name="line401">401: </a>  <A href="../../../../../docs/manualpages/Sys/PetscFree.html#PetscFree">PetscFree</A>(pa);

<a name="line403">403: </a>  <font color="#4169E1">for</font> (i=0; i&lt;nrqs; ++i) {
<a name="line404">404: </a>    <A href="../../../../../docs/manualpages/Sys/PetscFree.html#PetscFree">PetscFree</A>(rbuf2[i]);
<a name="line405">405: </a>  }
<a name="line406">406: </a>  <A href="../../../../../docs/manualpages/Sys/PetscFree.html#PetscFree">PetscFree</A>(rbuf2);
<a name="line407">407: </a>  <A href="../../../../../docs/manualpages/Sys/PetscFree4.html#PetscFree4">PetscFree4</A>(sbuf1,ptr,tmp,ctr);
<a name="line408">408: </a>  <A href="../../../../../docs/manualpages/Sys/PetscFree.html#PetscFree">PetscFree</A>(rbuf1[0]);
<a name="line409">409: </a>  <A href="../../../../../docs/manualpages/Sys/PetscFree.html#PetscFree">PetscFree</A>(rbuf1);

<a name="line411">411: </a>  <font color="#4169E1">for</font> (i=0; i&lt;nrqr; ++i) {
<a name="line412">412: </a>    <A href="../../../../../docs/manualpages/Sys/PetscFree.html#PetscFree">PetscFree</A>(sbuf2[i]);
<a name="line413">413: </a>  }

<a name="line415">415: </a>  <A href="../../../../../docs/manualpages/Sys/PetscFree.html#PetscFree">PetscFree</A>(sbuf2);
<a name="line416">416: </a>  <A href="../../../../../docs/manualpages/Sys/PetscFree.html#PetscFree">PetscFree</A>(rmap[0]);
<a name="line417">417: </a>  <A href="../../../../../docs/manualpages/Sys/PetscFree.html#PetscFree">PetscFree</A>(rmap);

<a name="line419">419: </a>  <font color="#4169E1">for</font> (i=0; i&lt;ismax; i++) {
<a name="line420">420: </a>    <A href="../../../../../docs/manualpages/Mat/MatAssemblyBegin.html#MatAssemblyBegin">MatAssemblyBegin</A>(submats[i],MAT_FINAL_ASSEMBLY);
<a name="line421">421: </a>    <A href="../../../../../docs/manualpages/Mat/MatAssemblyEnd.html#MatAssemblyEnd">MatAssemblyEnd</A>(submats[i],MAT_FINAL_ASSEMBLY);
<a name="line422">422: </a>  }

<a name="line424">424: </a>  <font color="#4169E1">return</font>(0);
<a name="line425">425: </a>}

<a name="line429">429: </a><strong><font color="#4169E1"><a name="MatScale_MPIDense"></a><A href="../../../../../docs/manualpages/Sys/PetscErrorCode.html#PetscErrorCode">PetscErrorCode</A> MatScale_MPIDense(<A href="../../../../../docs/manualpages/Mat/Mat.html#Mat">Mat</A> inA,<A href="../../../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</A> alpha)</font></strong>
<a name="line430">430: </a>{
<a name="line431">431: </a>  Mat_MPIDense   *A = (Mat_MPIDense*)inA-&gt;data;
<a name="line432">432: </a>  Mat_SeqDense   *a = (Mat_SeqDense*)A-&gt;A-&gt;data;
<a name="line433">433: </a>  <A href="../../../../../docs/manualpages/Sys/PetscScalar.html#PetscScalar">PetscScalar</A>    oalpha = alpha;
<a name="line435">435: </a>  <A href="../../../../../docs/manualpages/Sys/PetscBLASInt.html#PetscBLASInt">PetscBLASInt</A>   one = 1,nz = PetscBLASIntCast(inA-&gt;rmap-&gt;n*inA-&gt;cmap-&gt;N);

<a name="line438">438: </a>  BLASscal_(&amp;nz,&amp;oalpha,a-&gt;v,&amp;one);
<a name="line439">439: </a>  <A href="../../../../../docs/manualpages/Profiling/PetscLogFlops.html#PetscLogFlops">PetscLogFlops</A>(nz);
<a name="line440">440: </a>  <font color="#4169E1">return</font>(0);
<a name="line441">441: </a>}
</pre>
</body>

</html>
